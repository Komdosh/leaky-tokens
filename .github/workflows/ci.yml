name: CI (unit-only)

on:
  push:
    branches: ["**"]
  pull_request:
    branches: ["**"]

permissions:
  contents: write

jobs:
  dependency-review:
    if: github.event_name == 'pull_request'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Dependency review
        uses: actions/dependency-review-action@v4

  build-and-test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"
          cache: gradle

      - name: CI note
        run: |
          echo "This CI runner is resource constrained."
          echo "Only unit tests are executed; heavy or integration tests are skipped."

      - name: Build and unit tests
        run: ./gradlew test jacocoTestReport -DskipITs=true

      - name: Aggregate Gradle problems report
        if: always()
        run: |
          mkdir -p build/ci/gradle-problems
          found=0
          while IFS= read -r -d '' dir; do
            found=1
            module=$(echo "$dir" | sed -E 's|^\./||; s|/build/reports/problems$||; s|/|_|g')
            dest="build/ci/gradle-problems/${module}"
            mkdir -p "$dest"
            cp -R "$dir"/. "$dest"/
          done < <(find . -type d -path "*/build/reports/problems" -print0)
          if [ "$found" -eq 0 ]; then
            cat > build/ci/gradle-problems/README.txt <<EOF
            No Gradle problems report was generated in this run.
            This can happen when Gradle has nothing to report.
            EOF
          fi

      - name: Test report summary
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: "**/build/test-results/test/*.xml"
          summary: true
          detailed_summary: true
          require_tests: false

      - name: JaCoCo summary
        if: always()
        run: |
          echo "## JaCoCo Summary" >> "$GITHUB_STEP_SUMMARY"
          find . -path "*/build/reports/jacoco/test/jacocoTestReport.xml" -print0 | while IFS= read -r -d '' file; do
            module=$(basename "$(dirname "$(dirname "$(dirname "$file")")")")
            line=$(grep 'counter type="LINE"' "$file" | tail -n1 || true)
            branch=$(grep 'counter type="BRANCH"' "$file" | tail -n1 || true)
            line_missed=$(echo "$line" | sed -n 's/.*missed="\\([0-9]*\\)".*/\\1/p')
            line_covered=$(echo "$line" | sed -n 's/.*covered="\\([0-9]*\\)".*/\\1/p')
            branch_missed=$(echo "$branch" | sed -n 's/.*missed="\\([0-9]*\\)".*/\\1/p')
            branch_covered=$(echo "$branch" | sed -n 's/.*covered="\\([0-9]*\\)".*/\\1/p')
            if [ -n "$line_missed" ] && [ -n "$line_covered" ]; then
              line_total=$((line_missed + line_covered))
              line_pct=$(awk "BEGIN {printf \"%.2f\", ($line_covered/$line_total)*100}")
            else
              line_pct="no data"
            fi
            if [ -n "$branch_missed" ] && [ -n "$branch_covered" ]; then
              branch_total=$((branch_missed + branch_covered))
              branch_pct=$(awk "BEGIN {printf \"%.2f\", ($branch_covered/$branch_total)*100}")
            else
              branch_pct="no data"
            fi
            echo "- ${module}: line ${line_pct}% | branch ${branch_pct}%" >> "$GITHUB_STEP_SUMMARY"
          done

      - name: Upload JaCoCo reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: jacoco-reports
          path: |
            **/build/reports/jacoco/test
            **/build/reports/jacoco/test/html
          if-no-files-found: warn

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            **/build/reports/tests/test
            **/build/test-results/test
          if-no-files-found: warn

      - name: Upload Gradle problems report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gradle-problems
          path: |
            build/ci/gradle-problems/**
          if-no-files-found: warn

      - name: Generate coverage badge
        if: github.event_name == 'push'
        run: |
          total_missed=0
          total_covered=0
          while IFS= read -r -d '' file; do
            line=$(grep -m1 'counter type="LINE"' "$file" || true)
            missed=$(echo "$line" | sed -n 's/.*missed="\\([0-9]*\\)".*/\\1/p')
            covered=$(echo "$line" | sed -n 's/.*covered="\\([0-9]*\\)".*/\\1/p')
            if [ -n "$missed" ] && [ -n "$covered" ]; then
              total_missed=$((total_missed + missed))
              total_covered=$((total_covered + covered))
            fi
          done < <(find . -path "*/build/reports/jacoco/test/jacocoTestReport.xml" -print0)

          if [ "$total_missed" -eq 0 ] && [ "$total_covered" -eq 0 ]; then
            pct="0.00"
          else
            pct=$(awk "BEGIN {printf \"%.2f\", ($total_covered/($total_missed+$total_covered))*100}")
          fi

          color="red"
          pct_int=$(printf "%.0f" "$pct")
          if [ "$pct_int" -ge 90 ]; then color="brightgreen"; \
          elif [ "$pct_int" -ge 80 ]; then color="green"; \
          elif [ "$pct_int" -ge 70 ]; then color="yellowgreen"; \
          elif [ "$pct_int" -ge 60 ]; then color="yellow"; \
          elif [ "$pct_int" -ge 50 ]; then color="orange"; fi

          mkdir -p badges
          cat > badges/jacoco.svg <<SVG
          <svg xmlns="http://www.w3.org/2000/svg" width="110" height="20" role="img" aria-label="coverage: ${pct}%">
            <linearGradient id="s" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <rect rx="3" width="110" height="20" fill="#555"/>
            <rect rx="3" x="62" width="48" height="20" fill="${color}"/>
            <path fill="${color}" d="M62 0h4v20h-4z"/>
            <rect rx="3" width="110" height="20" fill="url(#s)"/>
            <g fill="#fff" text-anchor="middle" font-family="Verdana,Geneva,DejaVu Sans,sans-serif" font-size="11">
              <text x="31" y="14">coverage</text>
              <text x="85" y="14">${pct}%</text>
            </g>
          </svg>
          SVG

      - name: Commit coverage badge
        if: github.event_name == 'push'
        run: |
          if [ "${{ github.actor }}" = "github-actions[bot]" ]; then
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          if git status --porcelain | grep -q "badges/jacoco.svg"; then
            git add badges/jacoco.svg
            git commit -m "Update coverage badge [skip ci]" || true
            git push
          fi
